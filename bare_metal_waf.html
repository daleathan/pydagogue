<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Bare metal WAF &mdash; pydagogue 0.2 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="pydagogue 0.2 documentation" href="index.html" />
    <link rel="next" title="Booting Macs" href="booting_macs.html" />
    <link rel="prev" title="Floating point error" href="floating_error.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="booting_macs.html" title="Booting Macs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="floating_error.html" title="Floating point error"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">pydagogue 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="bare-metal-waf">
<h1>Bare metal WAF<a class="headerlink" href="#bare-metal-waf" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="http://code.google.com/waf">waf</a> is a configure / build / install system.</p>
<p>It can do the jobs of <tt class="docutils literal"><span class="pre">autotools</span></tt> and <tt class="docutils literal"><span class="pre">make</span></tt>, so instead of typing (say):</p>
<div class="highlight-python"><div class="highlight"><pre>./configure
make
make install
</pre></div>
</div>
<p>you can type (say):</p>
<div class="highlight-python"><div class="highlight"><pre>./waf configure
./waf build
./waf install
</pre></div>
</div>
<p>You don&#8217;t need <tt class="docutils literal"><span class="pre">autotools</span></tt> or <tt class="docutils literal"><span class="pre">make</span></tt> installed.  The full <tt class="docutils literal"><span class="pre">waf</span></tt> binary is
90K and usually sits in your source code repository.</p>
<p>waf uses a Python configuration file so you can use Python code to define your
configure, build and install rules rather than the obscure <tt class="docutils literal"><span class="pre">make</span></tt> syntax and
funny variable names.</p>
<p>Among other projects, SAMBA uses waf for its entire configure / build / install system.</p>
<p>There is a comprehensive waf manual.</p>
<p>What&#8217;s the downside?  The waf build system (like - say - <tt class="docutils literal"><span class="pre">make</span></tt>) works at a
fairly high and abstract level, so it can be hard to understand the flow of
control.  It can sometimes be hard to find the part of waf that you want.</p>
<p>This page has notes to myself about how waf works.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The heart of the waf process is of course the build.</p>
<p>We&#8217;re likely going to do this to build our project:</p>
<div class="highlight-python"><div class="highlight"><pre>./waf configure
./waf build
</pre></div>
</div>
<p>We use the configure step to check for dependencies and set up any variables we
need to define for the build step.</p>
<p>The build step receives the result of the configure step, and sets up build
rules.  The build rules form a directed acyclic graph.  At the end of the build
step waf will execute the build steps using the dependency information from the
DAG to execute the build steps in an efficient order.</p>
</div>
<div class="section" id="a-taster">
<h2>A taster<a class="headerlink" href="#a-taster" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s say you have a project <tt class="docutils literal"><span class="pre">myproject</span></tt>.  It&#8217;s a directory called
<tt class="docutils literal"><span class="pre">myproject</span></tt>.  It has a single C file <tt class="docutils literal"><span class="pre">myprogram.c</span></tt>.</p>
<p>Download the <tt class="docutils literal"><span class="pre">waf</span></tt> binary to the <tt class="docutils literal"><span class="pre">myproject</span></tt> from the <a class="reference external" href="http://code.google.com/waf">waf</a> site.</p>
<p>You invoke waf thus:</p>
<div class="highlight-python"><div class="highlight"><pre>cd myproject
./waf
</pre></div>
</div>
<p>and you&#8217;ll get this:</p>
<div class="highlight-python"><div class="highlight"><pre>Waf: Run from a directory containing a file named &#39;wscript&#39;
</pre></div>
</div>
<ul class="simple">
<li>the <tt class="docutils literal"><span class="pre">waf</span></tt> program loads a configuration file called <tt class="docutils literal"><span class="pre">wscript</span></tt></li>
</ul>
<p>waf loads the wscript file, and executes the code inside in order to do stuff.</p>
<p>Let&#8217;s pretend our project creates a file called <tt class="docutils literal"><span class="pre">foo</span></tt> and then copies it to
<tt class="docutils literal"><span class="pre">bar</span></tt>.  The wscript might look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="c"># Check we have &#39;touch&#39;</span>
    <span class="n">conf_ctx</span><span class="o">.</span><span class="n">find_program</span><span class="p">(</span><span class="s">&#39;touch&#39;</span><span class="p">,</span> <span class="n">VAR</span><span class="o">=</span><span class="s">&#39;TOUCH&#39;</span><span class="p">)</span>
    <span class="c"># And &#39;cp&#39;</span>
    <span class="n">conf_ctx</span><span class="o">.</span><span class="n">find_program</span><span class="p">(</span><span class="s">&#39;cp&#39;</span><span class="p">,</span> <span class="n">VAR</span><span class="o">=</span><span class="s">&#39;CP&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="c"># Touch foo</span>
    <span class="n">build_ctx</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">&#39;:math:`{TOUCH} `{TGT}&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
    <span class="c"># Copy foo to bar</span>
    <span class="n">build_ctx</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">&#39;:math:`{CP} `{SRC} :math:`{TGT}&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We run the checks with <tt class="docutils literal"><span class="pre">./waf</span> <span class="pre">configure</span></tt>, and the build with <tt class="docutils literal"><span class="pre">./waf</span> <span class="pre">build</span></tt>.</p>
<p>It isn&#8217;t easy to see exactly how this works, and rest of this page will try to
do that.</p>
</div>
<div class="section" id="waf-commands">
<h2>waf commands<a class="headerlink" href="#waf-commands" title="Permalink to this headline">¶</a></h2>
<p>You execute a waf command with <tt class="docutils literal"><span class="pre">.waf</span> <span class="pre">command-name</span> <span class="pre">[options]</span></tt></p>
<p>You can define any command you like with something like this in the wscript
file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript file</span>
<span class="k">def</span> <span class="nf">mycommand</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and:</p>
<div class="highlight-python"><div class="highlight"><pre>./waf mycommand
</pre></div>
</div>
<p>giving:</p>
<div class="highlight-python"><div class="highlight"><pre>hello
&#39;mycommand&#39; finished successfully (0.000s)
</pre></div>
</div>
<p>What happened?  waf loaded the wscript file, looked for a callable object called
<tt class="docutils literal"><span class="pre">mycommand</span></tt>, created a <tt class="docutils literal"><span class="pre">Context</span></tt> instance <tt class="docutils literal"><span class="pre">ctx</span></tt>, and passed it to the
callable thing as the first and only argument.</p>
<p>The <tt class="docutils literal"><span class="pre">ctx</span></tt> instance contains information about the current waf run.
We investigate with a print in the wscript:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript file</span>
<span class="k">def</span> <span class="nf">mycommand</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</pre></div>
</div>
<p>giving:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;waflib.Context.Context object at 0x1011b60d0&gt;
&#39;mycommand&#39; finished successfully (0.000s)
</pre></div>
</div>
<div class="section" id="special-commands">
<h3>Special commands<a class="headerlink" href="#special-commands" title="Permalink to this headline">¶</a></h3>
<p>The following commands are special to waf:</p>
<ul class="simple">
<li>options</li>
<li>configure</li>
<li>distclean</li>
<li>clean</li>
<li>build</li>
<li>install</li>
<li>uninstall</li>
<li>dist</li>
<li>list</li>
<li>step</li>
</ul>
<p>(there may be others I don&#8217;t know).</p>
<p>If you define functions (callables) with these names, they have default and
specialized behavior.  For example, each of these commands receives its own
specialized Context object. We can show that for the the <tt class="docutils literal"><span class="pre">options</span></tt> command.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="n">opt_ctx</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">opt_ctx</span><span class="p">)</span>
</pre></div>
</div>
<p>gives:</p>
<div class="highlight-python"><div class="highlight"><pre>` waf options
&lt;waflib.Options.OptionsContext object at 0x1011b53d0&gt;
</pre></div>
</div>
<p>Let&#8217;s make each of the commands print their context instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">for</span> <span class="n">command_name</span> <span class="ow">in</span> <span class="p">(</span>
    <span class="s">&#39;options&#39;</span><span class="p">,</span>
    <span class="s">&#39;configure&#39;</span><span class="p">,</span>
    <span class="s">&#39;distclean&#39;</span><span class="p">,</span>
    <span class="s">&#39;clean&#39;</span><span class="p">,</span>
    <span class="s">&#39;build&#39;</span><span class="p">,</span>
    <span class="s">&#39;install&#39;</span><span class="p">,</span>
    <span class="s">&#39;uninstall&#39;</span><span class="p">,</span>
    <span class="s">&#39;dist&#39;</span><span class="p">,</span>
    <span class="s">&#39;list&#39;</span><span class="p">,</span>
    <span class="s">&#39;step&#39;</span><span class="p">,</span>
    <span class="p">):</span>
    <span class="k">exec</span><span class="p">(</span><span class="s">&#39;{0} = lambda ctx : print(&quot;In: {0} with&quot;, ctx)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command_name</span><span class="p">))</span>
</pre></div>
</div>
<p>Executing &#8216;options&#8217; again:</p>
<div class="highlight-python"><div class="highlight"><pre>:math:` waf options
In: options with &lt;waflib.Options.OptionsContext object at 0x1011b55d0&gt;
</pre></div>
</div>
<p>We can execute all these command in order by concatenating them at the command
line to show they each get an instance of their own specialized Context:</p>
<div class="highlight-python"><div class="highlight"><pre>` waf options configure distclean clean build install uninstall dist list step
In: options with &lt;waflib.Options.OptionsContext object at 0x1011b6750&gt;
Setting top to                           : /Users/mb312/dev_trees/myproject
Setting out to                           : /Users/mb312/dev_trees/myproject/build
In: configure with &lt;waflib.Configure.ConfigurationContext object at 0x1011b6a50&gt;
&#39;configure&#39; finished successfully (0.017s)
In: distclean with &lt;waflib.Context.Context object at 0x1011b6c10&gt;
&#39;distclean&#39; finished successfully (0.000s)
In: build with &lt;waflib.Build.CleanContext object at 0x1011b6d50&gt;
&#39;clean&#39; finished successfully (0.008s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
In: build with &lt;waflib.Build.BuildContext object at 0x1011b6f50&gt;
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;build&#39; finished successfully (0.002s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
In: build with &lt;waflib.Build.InstallContext object at 0x1011c0210&gt;
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;install&#39; finished successfully (0.002s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
In: build with &lt;waflib.Build.UninstallContext object at 0x1011c04d0&gt;
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;uninstall&#39; finished successfully (0.013s)
In: dist with &lt;waflib.Scripting.Dist object at 0x1011c07d0&gt;
New archive created: noname-1.0.tar.bz2 (sha=&#39;38a85b35879a5b0703142c3c27e765bafb7fd4b6&#39;)
&#39;dist&#39; finished successfully (0.051s)
In: build with &lt;waflib.Build.ListContext object at 0x1011dcfd0&gt;
&#39;list&#39; finished successfully (0.003s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
In: build with &lt;waflib.Build.StepContext object at 0x1011e9550&gt;
Add a pattern for the debug build, for example &quot;waf step --files=main.c,app&quot;
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;step&#39; finished successfully (0.002s)
</pre></div>
</div>
</div>
<div class="section" id="some-commands-use-the-build-callable-instead-of-their-own-callable">
<h3>Some commands use the build callable instead of their own callable<a class="headerlink" href="#some-commands-use-the-build-callable-instead-of-their-own-callable" title="Permalink to this headline">¶</a></h3>
<p>You can see from the printout above that all of (clean, build, install,
uninstall, list, step) end up executing the &#8216;build&#8217; command not their own
commands.  If you want to specialize behavior of these commands, you&#8217;ll need to
put code in the <tt class="docutils literal"><span class="pre">build</span></tt> function (callable) to check the <tt class="docutils literal"><span class="pre">cmd</span></tt> attribute of
the build context to find which of these commands the <tt class="docutils literal"><span class="pre">build</span></tt> function is
running. See &#8220;More build commands&#8221; in the waf book for more detail.</p>
</div>
<div class="section" id="more-on-the-configure-command">
<h3>More on the configure command<a class="headerlink" href="#more-on-the-configure-command" title="Permalink to this headline">¶</a></h3>
<p>Executing the <tt class="docutils literal"><span class="pre">configure</span></tt> command will:</p>
<ul class="simple">
<li>call the options command</li>
<li>set some default path information</li>
</ul>
<p>This happens before your own <tt class="docutils literal"><span class="pre">configure</span></tt> command gets executed, and even if
there is no <tt class="docutils literal"><span class="pre">configure</span></tt> command defined.  For example, if wscript is an empty
file:</p>
<div class="highlight-python"><div class="highlight"><pre>:math:` waf configure
&lt;waflib.Options.OptionsContext object at 0x1011b53d0&gt;
Setting top to                           : /Users/mb312/dev_trees/myproject
Setting out to                           : /Users/mb312/dev_trees/myproject/build
No function configure defined in /Users/mb312/dev_trees/myproject/wscript
</pre></div>
</div>
<p>The default configure machinery has set the default &#8216;source&#8217; (<em>top</em>) directory
and the &#8216;build&#8217; (<em>out</em>) directory.  <em>top</em> is the (by default) the directory
containing the wscript file, and <em>out</em> is (by default) a subdirectory of <em>top</em>
called <tt class="docutils literal"><span class="pre">build</span></tt>.  You can customize these directories if you want, for example
by using the <tt class="docutils literal"><span class="pre">top</span></tt> and <tt class="docutils literal"><span class="pre">out</span></tt> global variables at the top of the wscript.</p>
</div>
</div>
<div class="section" id="how-the-build-gets-built">
<h2>How the build gets built<a class="headerlink" href="#how-the-build-gets-built" title="Permalink to this headline">¶</a></h2>
<p>See the waf book chapter called &#8220;Builds&#8221;.</p>
<p>A build consists of tasks.  Tasks are instances of subclasses of the
<tt class="docutils literal"><span class="pre">waflib.Task.Task</span></tt> class.  But - where is <tt class="docutils literal"><span class="pre">waflib</span></tt>?</p>
<div class="section" id="where-is-the-waf-code">
<h3>Where is the waf code?<a class="headerlink" href="#where-is-the-waf-code" title="Permalink to this headline">¶</a></h3>
<p>See &#8220;Local waflib folders&#8221; in the waf book.</p>
<p>The most way to use waf is to download the <tt class="docutils literal"><span class="pre">waf</span></tt> binary to your source code
tree, maybe checking the binary into your source control.</p>
<p>In this case, executing the <tt class="docutils literal"><span class="pre">./waf</span></tt> binary will automatically unpack the waf
code from within the binary to a specially named folder in the same directory as
the binary, with a name beginning with <tt class="docutils literal"><span class="pre">.waf-</span></tt>. For example, after I have run
<tt class="docutils literal"><span class="pre">./waf</span> <span class="pre">configure</span></tt> in the test project folder I get:</p>
<div class="highlight-python"><div class="highlight"><pre>` ls -A1
.lock-waf_darwin_build
.waf-1.7.13-5a064c2686fe54de4e11018d22148cfc
build
waf
wscript
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">waflib</span></tt> code is in this special <tt class="docutils literal"><span class="pre">.waf-*</span></tt> directory:</p>
<blockquote>
<div>:math:` ls .waf-1.7.13-5a064c2686fe54de4e11018d22148cfc/
waflib</div></blockquote>
<p>As the waf book explains, it&#8217;s also possible to run waf with <tt class="docutils literal"><span class="pre">waflib</span></tt> as a
standard folder in the source tree or elsewhere.</p>
</div>
<div class="section" id="high-level-api-for-creating-tasks">
<h3>High level API for creating tasks<a class="headerlink" href="#high-level-api-for-creating-tasks" title="Permalink to this headline">¶</a></h3>
<p>Usually we create tasks using a high-level API called <em>task generators</em>.  You
already saw these in first wscript towards the top of this page. The task
generator creates the task instances for us:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="n">build_ctx</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">&#39;touch `{TGT}&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="#variable-substitution"><em>run_str Variable substitution</em></a> below for more on the <tt class="docutils literal"><span class="pre">:math:`{TGT}</span></tt> string
substitution form.</p>
<p>The <tt class="docutils literal"><span class="pre">rule</span></tt> is a system command that we can run, and the <tt class="docutils literal"><span class="pre">target</span></tt> in this
case is a filename of a file we generate with the command.</p>
<p>From here on in, I&#8217;ll use the invocation <tt class="docutils literal"><span class="pre">waf</span> <span class="pre">distclean</span> <span class="pre">configure</span> <span class="pre">build</span></tt> to
run the waf build.  <tt class="docutils literal"><span class="pre">distclean</span></tt> deletes all the generated build targets,
clearing the outputs of any previous waf run.</p>
<p>So:</p>
<div class="highlight-python"><div class="highlight"><pre>` waf distclean configure build
Setting top to                           : /Users/mb312/dev_trees/myproject
Setting out to                           : /Users/mb312/dev_trees/myproject/build
&#39;configure&#39; finished successfully (0.003s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
[1/1] foo:  -&gt; build/foo
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;build&#39; finished successfully (0.024s)
</pre></div>
</div>
<p>The script generates an empty file <tt class="docutils literal"><span class="pre">build/foo</span></tt>.</p>
<p>The call to <tt class="docutils literal"><span class="pre">build_ctx()</span></tt> above is a very short piece of code that ends up
creating an instance of <tt class="docutils literal"><span class="pre">waflib.TaskGen.task_gen</span></tt>.  In due course this will
generate all the relevant <tt class="docutils literal"><span class="pre">Task</span></tt> instances.  Adpapting an example from the waf
book:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="n">tg</span> <span class="o">=</span> <span class="n">build_ctx</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">&#39;touch :math:`{TGT}&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
    <span class="c"># This will show that ``tg`` is a ``task_gen`` instance</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Type of tg is:&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">tg</span><span class="p">))</span>
    <span class="c"># ``tg.tasks`` is empty because the generator has not run yet</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Task list before tg.post()&#39;</span><span class="p">,</span> <span class="n">tg</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
    <span class="c"># ``tg.post()`` runs the generator and fills the task list</span>
    <span class="n">tg</span><span class="o">.</span><span class="n">post</span><span class="p">()</span>
    <span class="c"># The task list now contains a single task</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Task list after tg.post()&#39;</span><span class="p">,</span> <span class="n">tg</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Type of tg.tasks[0] is:&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">tg</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
<p>so:</p>
<div class="highlight-python"><div class="highlight"><pre>` waf distclean configure build
&#39;distclean&#39; finished successfully (0.002s)
Setting top to                           : /Users/mb312/dev_trees/myproject
Setting out to                           : /Users/mb312/dev_trees/myproject/build
&#39;configure&#39; finished successfully (0.003s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
Type of tg is: &lt;class &#39;waflib.TaskGen.task_gen&#39;&gt;
Task list before tg.post() []
Task list after tg.post() [
    {task 4313537616: foo  -&gt; foo}]
Type of tg.tasks[0] is: &lt;class &#39;waflib.Task.foo&#39;&gt;
[1/1] foo:  -&gt; build/foo
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;build&#39; finished successfully (0.019s)
</pre></div>
</div>
</div>
<div class="section" id="nodes">
<h3>Nodes<a class="headerlink" href="#nodes" title="Permalink to this headline">¶</a></h3>
<p>Before we do some low-level API examples, we need some explanation of the waf
concept of &#8216;nodes&#8217;.</p>
<p>&#8216;nodes&#8217; are waf objects representing files or directories on the filesystem.
The files or directories may or may not exist at the time you create the node.</p>
<p>The waf book has a chapter devoted to &#8220;Node objects&#8221;.</p>
<p>Two node objects get automatically created and attached to the &#8216;Context&#8217; of
every command - &#8216;path&#8217; and &#8216;root&#8217;.  Here we use a custom command which receives
an instance of the base <tt class="docutils literal"><span class="pre">Context</span></tt> class.  All command contexts will have these
node objects:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">def</span> <span class="nf">mycommand</span><span class="p">(</span><span class="n">base_ctx</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">base_ctx</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">base_ctx</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">base_ctx</span><span class="o">.</span><span class="n">root</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">base_ctx</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>
</pre></div>
</div>
<p>giving:</p>
<div class="highlight-python"><div class="highlight"><pre>:math:` waf mycommand
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /Users/mb312/dev_trees/myproject
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /
&#39;mycommand&#39; finished successfully (0.000s)
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">base_ctx.path</span></tt> is a node pointing to the directory containing the executed
wscript file. <tt class="docutils literal"><span class="pre">base_ctx.root</span></tt> is a node pointing to the root directory of the
filesystem containing the wscript.</p>
<p>Node objects contain various useful methods:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">def</span> <span class="nf">mycommand</span><span class="p">(</span><span class="n">base_ctx</span><span class="p">):</span>
    <span class="c"># Show the attributes that are not private</span>
    <span class="k">print</span><span class="p">([</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">base_ctx</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)])</span>
</pre></div>
</div>
<p>gives:</p>
<div class="highlight-python"><div class="highlight"><pre>` waf mycommand
[&#39;abspath&#39;, &#39;ant_glob&#39;, &#39;ant_iter&#39;, &#39;bld_base&#39;, &#39;bld_dir&#39;, &#39;bldpath&#39;,
&#39;cache_abspath&#39;, &#39;cache_isdir&#39;, &#39;cache_sig&#39;, &#39;change_ext&#39;, &#39;children&#39;,
&#39;chmod&#39;, &#39;ctx&#39;, &#39;delete&#39;, &#39;evict&#39;, &#39;find_dir&#39;, &#39;find_node&#39;,
&#39;find_or_declare&#39;, &#39;find_resource&#39;, &#39;get_bld&#39;, &#39;get_bld_sig&#39;, &#39;get_src&#39;,
&#39;height&#39;, &#39;is_bld&#39;, &#39;is_child_of&#39;, &#39;is_src&#39;, &#39;listdir&#39;, &#39;make_node&#39;,
&#39;mkdir&#39;, &#39;name&#39;, &#39;nice_path&#39;, &#39;parent&#39;, &#39;path_from&#39;, &#39;read&#39;, &#39;relpath&#39;,
&#39;search&#39;, &#39;search_node&#39;, &#39;sig&#39;, &#39;srcpath&#39;, &#39;suffix&#39;, &#39;write&#39;]
&#39;mycommand&#39; finished successfully (0.001s)
</pre></div>
</div>
<p>The waf book goes into more detail about these methods.</p>
<p>One interesting method is <tt class="docutils literal"><span class="pre">abspath()</span></tt>.  It gives the absolute path to the
node as a string:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">def</span> <span class="nf">mycommand</span><span class="p">(</span><span class="n">base_ctx</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">base_ctx</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">())</span>
</pre></div>
</div>
<p>for output:</p>
<div class="highlight-python"><div class="highlight"><pre>:math:` waf mycommand
/Users/mb312/dev_trees/myproject
&#39;mycommand&#39; finished successfully (0.000s)
</pre></div>
</div>
</div>
<div class="section" id="creating-nodes">
<h3>Creating nodes<a class="headerlink" href="#creating-nodes" title="Permalink to this headline">¶</a></h3>
<p>Here are some useful ordinary methods for creating nodes.  By &#8216;ordinary&#8217; I mean
methods that work for all command contexts (base <tt class="docutils literal"><span class="pre">Context</span></tt>, <tt class="docutils literal"><span class="pre">BuildContext</span></tt>,
<tt class="docutils literal"><span class="pre">OptionContext</span></tt> etc).</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">.search(path)</span></tt> : search for an already-created node for <tt class="docutils literal"><span class="pre">path</span></tt></li>
<li><tt class="docutils literal"><span class="pre">.find_node(path)</span></tt> : create a node for <tt class="docutils literal"><span class="pre">path</span></tt> if it exists on the
filesystem, return None otherwise</li>
<li><tt class="docutils literal"><span class="pre">.make_node(path)</span></tt> : create a node for <tt class="docutils literal"><span class="pre">path</span></tt> whether <tt class="docutils literal"><span class="pre">path</span></tt>
exists on the filesystem or not.</li>
<li><tt class="docutils literal"><span class="pre">.find_dir(dirname)</span></tt>: create a node for <tt class="docutils literal"><span class="pre">dirname</span></tt> if it exists on the
filesystem and is a directory, return None otherwise. This is just
<tt class="docutils literal"><span class="pre">.find_node(path)</span></tt> with an extra check that <tt class="docutils literal"><span class="pre">path</span></tt> is in fact a
directory.</li>
</ul>
</div>
<div class="section" id="waf-creates-some-nodes-automatically-but-not-many">
<h3>waf creates some nodes automatically, but not many<a class="headerlink" href="#waf-creates-some-nodes-automatically-but-not-many" title="Permalink to this headline">¶</a></h3>
<p>When waf creates <tt class="docutils literal"><span class="pre">path</span></tt> and <tt class="docutils literal"><span class="pre">root</span></tt> nodes, it also creates some nodes for
other parts of the system file tree, but not all. This is in order not to waste
time reading the file system for nodes that may not be needed.  Call this lazy
node creation.</p>
<p>Lazy node creation may come up in two situations.  The first is when using
<tt class="docutils literal"><span class="pre">.search(path)</span></tt> (above).  This will only find nodes that are already
defined.  For example, if you do <tt class="docutils literal"><span class="pre">build_ctx.path.search('waf')</span></tt> at the
beginning of your build command, you will usually get None, even if the file
<tt class="docutils literal"><span class="pre">waf</span></tt> does exist in the folder referred to by the <tt class="docutils literal"><span class="pre">path</span></tt> node.  You probably
want <tt class="docutils literal"><span class="pre">.find_node(path)</span></tt> instead, which will read the filesystem and create
a node if the file exists.</p>
<p>Another place where lazy node creation is relevant is interpreting the
<tt class="docutils literal"><span class="pre">children</span></tt> attribute of a directory node. <tt class="docutils literal"><span class="pre">children</span></tt> is a dictionary giving
nodes corresponding to the contents of a directory. For efficiency, waf doesn&#8217;t
alaways read the filesystem to fill this structure, so you may need to create
nodes manually if they have not been read from the filesystem already:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">mycommand</span><span class="p">(</span><span class="n">base_ctx</span><span class="p">):</span>
    <span class="c"># The children of the root directory</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;root node children&#39;</span><span class="p">,</span> <span class="n">base_ctx</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
    <span class="c"># There are many more directories than found in the children</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;ls of root directory&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This gives:</p>
<div class="highlight-python"><div class="highlight"><pre>` waf mycommand
root node children {&#39;Users&#39;: /Users}
ls of root directory [&#39;.dbfseventsd&#39;, &#39;.DS_Store&#39;, &#39;.file&#39;, &#39;.fseventsd&#39;,
&#39;.hotfiles.btree&#39;, &#39;.Spotlight-V100&#39;, &#39;.Trashes&#39;, &#39;.vol&#39;, &#39;Applications&#39;,
&#39;bin&#39;, &#39;cores&#39;, &#39;dev&#39;, &#39;Developer&#39;, &#39;etc&#39;, &#39;home&#39;, &#39;Library&#39;, &#39;mach_kernel&#39;,
&#39;net&#39;, &#39;Network&#39;, &#39;opt&#39;, &#39;private&#39;, &#39;sbin&#39;, &#39;System&#39;, &#39;tmp&#39;, &#39;User Guides
And Information&#39;, &#39;Users&#39;, &#39;usr&#39;, &#39;var&#39;, &#39;Volumes&#39;]
&#39;mycommand&#39; finished successfully (0.000s)
</pre></div>
</div>
</div>
<div class="section" id="specialized-noding-for-builds">
<h3>Specialized noding for builds<a class="headerlink" href="#specialized-noding-for-builds" title="Permalink to this headline">¶</a></h3>
<p>This describes node stuff that only applies to the <tt class="docutils literal"><span class="pre">BuildContext</span></tt> - the
context object passed to a <tt class="docutils literal"><span class="pre">build</span></tt> command.</p>
<div class="section" id="build-and-source-nodes">
<h4>build and source nodes<a class="headerlink" href="#build-and-source-nodes" title="Permalink to this headline">¶</a></h4>
<p>The build context is a special context passed to the <tt class="docutils literal"><span class="pre">build</span></tt> command.</p>
<p>The build also needs to know about the location of the directory containing the
source files, and the output directory to put the target files. To solve this,
the build context contains two extra nodes, <tt class="docutils literal"><span class="pre">bldnode</span></tt> and <tt class="docutils literal"><span class="pre">srcnode</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">root</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">srcnode</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">srcnode</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">bldnode</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">bldnode</span><span class="p">))</span>
</pre></div>
</div>
<p>so:</p>
<div class="highlight-python"><div class="highlight"><pre>:math:` waf distclean configure build
&#39;distclean&#39; finished successfully (0.003s)
Setting top to                           : /Users/mb312/dev_trees/myproject
Setting out to                           : /Users/mb312/dev_trees/myproject/build
&#39;configure&#39; finished successfully (0.003s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /Users/mb312/dev_trees/myproject
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /Users/mb312/dev_trees/myproject
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /Users/mb312/dev_trees/myproject/build
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;build&#39; finished successfully (0.005s)
</pre></div>
</div>
<p>The source node path may differ from the &#8216;path&#8217; if you&#8217;ve customized the <em>top</em>
or <em>out</em> directories:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="n">top</span> <span class="o">=</span> <span class="s">&#39;tmp2&#39;</span>
<span class="n">out</span> <span class="o">=</span> <span class="s">&#39;tmp2/build2&#39;</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">root</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">srcnode</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">srcnode</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">bldnode</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">bldnode</span><span class="p">))</span>
</pre></div>
</div>
<p>We need to create the <tt class="docutils literal"><span class="pre">tmp2</span></tt> directory in the project directory in order for
this not to raise an error:</p>
<div class="highlight-python"><div class="highlight"><pre>mkdir tmp2
</pre></div>
</div>
<p>then:</p>
<div class="highlight-python"><div class="highlight"><pre>` waf distclean configure build
&#39;distclean&#39; finished successfully (0.002s)
Setting top to                           : /Users/mb312/dev_trees/myproject/tmp2
Setting out to                           : /Users/mb312/dev_trees/myproject/tmp2/build2
Are you certain that you do not want to set top=&quot;.&quot; ?
&#39;configure&#39; finished successfully (0.004s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/tmp2/build2&#39;
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /Users/mb312/dev_trees/myproject
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /Users/mb312/dev_trees/myproject/tmp2
&lt;class &#39;waflib.Node.Nod3&#39;&gt; /Users/mb312/dev_trees/myproject/tmp2/build2
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/tmp2/build2&#39;
&#39;build&#39; finished successfully (0.025s)
</pre></div>
</div>
<p>Iff you have a build context <tt class="docutils literal"><span class="pre">bldnode</span></tt>, you can get the source node with
<tt class="docutils literal"><span class="pre">get_src</span></tt>; if you have the build context <tt class="docutils literal"><span class="pre">srcnode</span></tt> you can get the build
node with <tt class="docutils literal"><span class="pre">get_bld</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="n">top</span> <span class="o">=</span> <span class="s">&#39;tmp2&#39;</span>
<span class="n">out</span> <span class="o">=</span> <span class="s">&#39;tmp2/build2&#39;</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">srcnode</span><span class="o">.</span><span class="n">get_bld</span><span class="p">()))</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">bldnode</span><span class="o">.</span><span class="n">get_src</span><span class="p">()))</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-python"><div class="highlight"><pre>:math:` waf distclean configure build
&#39;distclean&#39; finished successfully (0.002s)
Setting top to                           : /Users/mb312/dev_trees/myproject/tmp2
Setting out to                           : /Users/mb312/dev_trees/myproject/tmp2/build2
Are you certain that you do not want to set top=&quot;.&quot; ?
&#39;configure&#39; finished successfully (0.003s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/tmp2/build2&#39;
/Users/mb312/dev_trees/myproject/tmp2/build2
/Users/mb312/dev_trees/myproject/tmp2
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/tmp2/build2&#39;
&#39;build&#39; finished successfully (0.005s)
</pre></div>
</div>
<p>Careful with these methods - if you call them on nodes other than <tt class="docutils literal"><span class="pre">bldnode</span></tt> or
<tt class="docutils literal"><span class="pre">srcnode</span></tt>, you may well not get what you expect.</p>
</div>
<div class="section" id="where-s-my-node-build-or-source">
<h4>Where&#8217;s my node - build or source?<a class="headerlink" href="#where-s-my-node-build-or-source" title="Permalink to this headline">¶</a></h4>
<p>During the build, we may want to create nodes that might refer to the source
tree or to the build tree.  For example you could imagine a command
<tt class="docutils literal"><span class="pre">my_find_node_build_source(path)</span></tt> which would look for <tt class="docutils literal"><span class="pre">path</span></tt> in the
source tree, then in the build tree.  There are a couple of node methods that
look both in the source tree and the build tree.  These both only work for build
contexts:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">.find_resource(path)</span></tt>: first look for an existing node in the build node
tree, return if found.  Then look for <tt class="docutils literal"><span class="pre">path</span></tt> in the source filesystem,
create a node and return if found.  Otherwise return None.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">.find_or_declare(path)</span></tt>:</p>
<ol class="arabic simple">
<li>look for an existing node in the build node tree. Return that node if it
exists.</li>
<li>look for corresponding path in the source filesystem, make a node for the
path and return it if the path exists.</li>
<li>Make a new node in the build node tree for this path and return that node.</li>
</ol>
<p>In each case, if the file corresponding to the node does not already exist,
create the path to that file if the path does not yet exist on the filesystem.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="low-level-api-for-tasks">
<h3>Low-level API for tasks<a class="headerlink" href="#low-level-api-for-tasks" title="Permalink to this headline">¶</a></h3>
<p>As we saw above, the high-level API generates &#8216;task&#8217; instances.</p>
<p>The low-level API creates task instances directly.</p>
<p>See the &#8220;Direct task declaration&#8221; in the waf book for details.</p>
<p>Here&#8217;s an example of the high level interface.  Then we&#8217;ll do the same with the
low-level interface:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="c"># create empty &#39;foo&#39; file</span>
    <span class="n">build_ctx</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">&#39;touch `{TGT}&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
    <span class="c"># copy &#39;foo&#39; to &#39;bar&#39;</span>
    <span class="n">build_ctx</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">&#39;cp :math:`{SRC} `{TGT}&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Thence:</p>
<div class="highlight-python"><div class="highlight"><pre>:math:` waf distclean configure build
&#39;distclean&#39; finished successfully (0.002s)
Setting top to                           : /Users/mb312/dev_trees/myproject
Setting out to                           : /Users/mb312/dev_trees/myproject/build
&#39;configure&#39; finished successfully (0.003s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
[1/2] foo:  -&gt; build/foo
[2/2] bar: build/foo -&gt; build/bar
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;build&#39; finished successfully (0.035s)
</pre></div>
</div>
<p>The low level interface defines the tasks and dependencies directly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">waflib.Task</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="c"># Declare the tasks</span>
    <span class="k">class</span> <span class="nc">TouchFile</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ret_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span>
                <span class="s">&#39;touch {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abspath</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">ret_code</span>

    <span class="k">class</span> <span class="nc">CopyFile</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">ret_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span>
                <span class="s">&#39;cp {0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abspath</span><span class="p">(),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abspath</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">ret_code</span>
    <span class="c"># Instantiate tasks</span>
    <span class="n">touch_task</span> <span class="o">=</span> <span class="n">TouchFile</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
    <span class="n">touch_task</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">find_or_declare</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">))</span>
    <span class="n">cp_task</span> <span class="o">=</span> <span class="n">CopyFile</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
    <span class="n">cp_task</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">find_resource</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">))</span>
    <span class="n">cp_task</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">find_or_declare</span><span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">))</span>
    <span class="c"># Add them to a run group to schedule them</span>
    <span class="n">build_ctx</span><span class="o">.</span><span class="n">add_to_group</span><span class="p">(</span><span class="n">touch_task</span><span class="p">)</span>
    <span class="n">build_ctx</span><span class="o">.</span><span class="n">add_to_group</span><span class="p">(</span><span class="n">cp_task</span><span class="p">)</span>
    <span class="c"># Build machinery will submit and run these defined tasks</span>
</pre></div>
</div>
<p>giving output:</p>
<div class="highlight-python"><div class="highlight"><pre>` waf distclean configure build
&#39;distclean&#39; finished successfully (0.002s)
Setting top to                           : /Users/mb312/dev_trees/myproject
Setting out to                           : /Users/mb312/dev_trees/myproject/build
&#39;configure&#39; finished successfully (0.003s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
[1/2] TouchFile:  -&gt; build/foo
[2/2] CopyFile: build/foo -&gt; build/bar
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;build&#39; finished successfully (0.040s)
</pre></div>
</div>
<p>We can also define tasks using the slightly higher-level <tt class="docutils literal"><span class="pre">run_str</span></tt> attribute
instead of the <tt class="docutils literal"><span class="pre">run</span></tt> method.  waf translates the <tt class="docutils literal"><span class="pre">run_str</span></tt> attribute to a
<tt class="docutils literal"><span class="pre">run</span></tt> method automatically on execution, to give the same result:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="kn">from</span> <span class="nn">waflib.Task</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="c"># Declare the tasks</span>
    <span class="k">class</span> <span class="nc">TouchFile</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
        <span class="n">run_str</span> <span class="o">=</span> <span class="s">&#39;touch :math:`{TGT}&#39;</span>

    <span class="k">class</span> <span class="nc">CopyFile</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
        <span class="n">run_str</span> <span class="o">=</span> <span class="s">&#39;cp `{SRC} :math:`{TGT}&#39;</span>

    <span class="c"># Instantiate tasks</span>
    <span class="n">touch_task</span> <span class="o">=</span> <span class="n">TouchFile</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
    <span class="n">touch_task</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">find_or_declare</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">))</span>
    <span class="n">cp_task</span> <span class="o">=</span> <span class="n">CopyFile</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
    <span class="n">cp_task</span><span class="o">.</span><span class="n">set_inputs</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">find_resource</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">))</span>
    <span class="n">cp_task</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">build_ctx</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">find_or_declare</span><span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">))</span>
    <span class="c"># Add them to a run group to schedule them</span>
    <span class="n">build_ctx</span><span class="o">.</span><span class="n">add_to_group</span><span class="p">(</span><span class="n">touch_task</span><span class="p">)</span>
    <span class="n">build_ctx</span><span class="o">.</span><span class="n">add_to_group</span><span class="p">(</span><span class="n">cp_task</span><span class="p">)</span>
    <span class="c"># Build machinery will submit and run these defined tasks</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="run-str-variable-substitution">
<span id="variable-substitution"></span><h2>run_str Variable substitution<a class="headerlink" href="#run-str-variable-substitution" title="Permalink to this headline">¶</a></h2>
<p>As we&#8217;ve seen, a Task can define a system command by defining a <tt class="docutils literal"><span class="pre">run</span></tt> method,
or a <tt class="docutils literal"><span class="pre">run_str</span></tt>, which will be compiled into a <tt class="docutils literal"><span class="pre">run</span></tt> method.</p>
<p>If you pass a string using the <tt class="docutils literal"><span class="pre">rule=</span></tt> keyword argument to the high-level API,
this also becomes the <tt class="docutils literal"><span class="pre">run_str</span></tt> of the task.</p>
<p>As you can see from the examples above, the run_str has some extra rules of
variable substitution.</p>
<p>For example, <tt class="docutils literal"><span class="pre">`{SRC}</span></tt> and <tt class="docutils literal"><span class="pre">:math:`{TGT}</span></tt> get substituted for the <tt class="docutils literal"><span class="pre">source</span></tt> and
<tt class="docutils literal"><span class="pre">target</span></tt> filenames.  Other variable names that work in this mode
(<tt class="docutils literal"><span class="pre">`{VARIABLE_NAME}</span></tt>) are any attribute of <tt class="docutils literal"><span class="pre">build_ctx.env</span></tt>.</p>
<p>See <em>Scriptlet expressions</em> in the waf book for more substitutions. Here I&#8217;ve
copied from the book:</p>
<div class="highlight-python"><div class="highlight"><pre>1. If the value starts by env, gen, bld or tsk, a method call will be made
2. If the value starts by SRC[n] or TGT[n], a method call to the
   input/output node n will be made
3. SRC represents the list of task inputs seen from the root of the build directory
4. TGT represents the list of task outputs seen from the root of the build directory
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># whole wscript</span>
<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="n">conf_ctx</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">MYVAR</span> <span class="o">=</span> <span class="s">&#39;my variable&#39;</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="n">build_ctx</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">&#39;echo :math:`{MYVAR}&#39;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">build_ctx</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">&#39;echo `{bld.bldnode.abspath()}&#39;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">build_ctx</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">&#39;echo :math:`{bld.srcnode.abspath()}&#39;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>gives:</p>
<div class="highlight-python"><div class="highlight"><pre>` waf configure build
Setting top to                           : /Users/mb312/dev_trees/myproject
Setting out to                           : /Users/mb312/dev_trees/myproject/build
&#39;configure&#39; finished successfully (0.003s)
Waf: Entering directory `/Users/mb312/dev_trees/myproject/build&#39;
[2/3] echo :math:`{MYVAR}:
[2/3] echo `{bld.bldnode.abspath()}:
my variable
[3/3] echo ${bld.srcnode.abspath()}:
/Users/mb312/dev_trees/myproject/build
/Users/mb312/dev_trees/myproject
Waf: Leaving directory `/Users/mb312/dev_trees/myproject/build&#39;
&#39;build&#39; finished successfully (0.030s)
</pre></div>
</div>
</div>
<div class="section" id="ipython-debugging-in-waf">
<h2>IPython debugging in waf<a class="headerlink" href="#ipython-debugging-in-waf" title="Permalink to this headline">¶</a></h2>
<p>As of the IPython development tree of Christmas 2013, this works to drop you
into the IPython shell from waf:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the whole wscript</span>
<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">conf_ctx</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">build_ctx</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">embed</span>
    <span class="kn">from</span> <span class="nn">IPython.core.interactiveshell</span> <span class="kn">import</span> <span class="n">DummyMod</span>
    <span class="n">wscript_module</span> <span class="o">=</span> <span class="n">DummyMod</span><span class="p">()</span>
    <span class="n">wscript_module</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
    <span class="n">wscript_module</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="s">&#39;wscript&#39;</span>
    <span class="n">embed</span><span class="p">(</span><span class="n">user_module</span><span class="o">=</span><span class="n">wscript_module</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Bare metal WAF</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#a-taster">A taster</a></li>
<li><a class="reference internal" href="#waf-commands">waf commands</a><ul>
<li><a class="reference internal" href="#special-commands">Special commands</a></li>
<li><a class="reference internal" href="#some-commands-use-the-build-callable-instead-of-their-own-callable">Some commands use the build callable instead of their own callable</a></li>
<li><a class="reference internal" href="#more-on-the-configure-command">More on the configure command</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-the-build-gets-built">How the build gets built</a><ul>
<li><a class="reference internal" href="#where-is-the-waf-code">Where is the waf code?</a></li>
<li><a class="reference internal" href="#high-level-api-for-creating-tasks">High level API for creating tasks</a></li>
<li><a class="reference internal" href="#nodes">Nodes</a></li>
<li><a class="reference internal" href="#creating-nodes">Creating nodes</a></li>
<li><a class="reference internal" href="#waf-creates-some-nodes-automatically-but-not-many">waf creates some nodes automatically, but not many</a></li>
<li><a class="reference internal" href="#specialized-noding-for-builds">Specialized noding for builds</a><ul>
<li><a class="reference internal" href="#build-and-source-nodes">build and source nodes</a></li>
<li><a class="reference internal" href="#where-s-my-node-build-or-source">Where&#8217;s my node - build or source?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#low-level-api-for-tasks">Low-level API for tasks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#run-str-variable-substitution">run_str Variable substitution</a></li>
<li><a class="reference internal" href="#ipython-debugging-in-waf">IPython debugging in waf</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="floating_error.html"
                        title="previous chapter">Floating point error</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="booting_macs.html"
                        title="next chapter">Booting Macs</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/bare_metal_waf.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="booting_macs.html" title="Booting Macs"
             >next</a> |</li>
        <li class="right" >
          <a href="floating_error.html" title="Floating point error"
             >previous</a> |</li>
        <li><a href="index.html">pydagogue 0.2 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, 2010 - Matthew Brett.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
  </body>
</html>