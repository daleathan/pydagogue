<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>An algorithm for git push &mdash; pydagogue 0.2 documentation</title>
    
    <link rel="stylesheet" href="_static/traditional.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="pydagogue 0.2 documentation" href="index.html" />
    <link rel="up" title="Notes and tutorials on git" href="git.html" />
    <link rel="next" title="Git foundations" href="foundation.html" />
    <link rel="prev" title="Types of git objects" href="git_object_types.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="foundation.html" title="Git foundations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="git_object_types.html" title="Types of git objects"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">pydagogue 0.2 documentation</a> &raquo;</li>
          <li><a href="git.html" accesskey="U">Notes and tutorials on git</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="an-algorithm-for-git-push">
<h1>An algorithm for git push<a class="headerlink" href="#an-algorithm-for-git-push" title="Permalink to this headline">¶</a></h1>
<p>We saw how git stores its object in <a class="reference internal" href="curious_git.html"><em>The curious coder&#8217;s guide to git</em></a>.</p>
<p>Now we know about how git stores its objects, we can work out how git knows
which objects to copy when it does a push.</p>
<div class="section" id="paths-through-commits">
<h2>Paths through commits<a class="headerlink" href="#paths-through-commits" title="Permalink to this headline">¶</a></h2>
<p>Git commits form a graph.  The commits are the <em>nodes</em> in the graph.  Each
commit (except the first) has one or more parents, stored as hash references
in the commit object. The references to commit parents are the links
between nodes that form the <em>edges</em> in the graph.</p>
<p>The output of <tt class="docutils literal"><span class="pre">git</span> <span class="pre">log</span> <span class="pre">--graph</span></tt> shows the sequence of commits as a graph,
with commits as nodes and parent links as edges.  Here&#8217;s some example output
from the <tt class="docutils literal"><span class="pre">git</span> <span class="pre">log</span></tt> command with flags to make the graph structure more
obvious:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>desktop<span class="o">]</span><span class="nv">$ </span>git log --graph --oneline --topo-order 4a763d5
*   4a763d5 Completed merge of trouble, fixing conflicts along the way
|<span class="se">\ </span> 
| * 1b042ca Changes in the trouble branch
* | ec4d434 Mainline work
|/  
*   173de81 Merge in the experiment
|<span class="se">\ </span> 
| * ef61c8d Trying something new
* | e17fac0 The mainline keeps moving
|/  
* 17d7aaf I like this new name better
* d10d1b6 Luckily we submitted the paper before we realized
* 13fcdb3 Paper ready <span class="k">for </span>submission to Science
* 722f81d Fruit of enormous thought
* 90dcc35 First backup of my amazing idea
</pre></div>
</div>
<p>If we start at a particular commit, and then track back following only one
parent for each commit, this is a <em>path</em> in the <em>commit history</em>.</p>
<p>See <a class="reference internal" href="git_log_dots.html#git-reachable"><em>defining paths</em></a> for a more formal definition of a
commit path.</p>
</div>
<div class="section" id="an-algorithm">
<h2>An algorithm<a class="headerlink" href="#an-algorithm" title="Permalink to this headline">¶</a></h2>
<p>Something like this algorithm might do the job:</p>
<ol class="arabic simple">
<li>Get the commit hash corresponding the branch we are going to push;</li>
<li>Follow every <a class="reference internal" href="curious_git.html#git-graph"><em>commit path</em></a> back from this commit, until we hit a commit hash
(filename) that the remote has.  All the previous commits on the path, that
the remote does not have, are <em>missing commits</em>; #. For every <em>missing
commit</em> get the corresponding tree (directory listing) object.  If the tree
object is not in the remote objects directory, add to
the list of <em>missing trees</em>;</li>
<li>For every <em>missing tree</em> read the tree directory listing. Find any blob
(file) objects in the directory listing that are not in the remote objects
directory, add to the list of <em>missing blob</em> objects <a class="footnote-reference" href="#sub-trees" id="id1">[1]</a>;</li>
<li>Copy all <em>missing commit</em>, <em>missing tree</em> and <em>missing blob</em> objects to the
remote objects directory;</li>
<li>Update the remote branch to point to the same commit as the local branch;</li>
<li>Update the local record of the last known position of the remote branch to
point to the same commit.</li>
</ol>
<p>There&#8217;s a specific example of <tt class="docutils literal"><span class="pre">git</span> <span class="pre">push</span></tt> at <a class="reference internal" href="curious_git.html#git-push"><em>git push – synchronizing repositories</em></a>. Here is how
that example would follow our algorithm:</p>
<ol class="arabic simple">
<li>We look up the hash for <tt class="docutils literal"><span class="pre">master</span></tt>, and we get <tt class="docutils literal"><span class="pre">4c0d480cc1588b4f3e78f7798ee1103655b8276e</span></tt> (abbreviated as
<tt class="docutils literal"><span class="pre">4c0d480</span></tt>);</li>
<li>We follow all commit history paths back from <tt class="docutils literal"><span class="pre">4c0d480</span></tt> to check for
missing commits. We start with <tt class="docutils literal"><span class="pre">4c0d480</span></tt>. The remote does not have a
matching file in <tt class="docutils literal"><span class="pre">objects</span></tt>, so this is a missing commit. We only have one
path to follow, because <tt class="docutils literal"><span class="pre">4c0d480</span></tt> has only one parent –
<tt class="docutils literal"><span class="pre">4a763d5</span></tt> – and the remote does have a corresponding object, so
we can stop looking for missing commits;</li>
<li>We only have one missing commit, <tt class="docutils literal"><span class="pre">4c0d480</span></tt>.  We look in the contents of
<tt class="docutils literal"><span class="pre">4c0d480</span></tt> to find the tree object hash.  This is <tt class="docutils literal"><span class="pre">7f0de8dd99ee5c9987309668b5835796dc9c98c5</span></tt>.  We
check for this object in the remote objects directory, and sure enough, it
is missing. We add this tree to the list of missing trees;</li>
<li>We only have one missing tree – <tt class="docutils literal"><span class="pre">7f0de8dd99ee5c9987309668b5835796dc9c98c5</span></tt>. We look in the contents
of this tree object and check in the remote object directory for each
object in this listing. The only missing object is <tt class="docutils literal"><span class="pre">bfb83ae9365ab2a8343ef5f3cb77f834bdffff93</span></tt>;</li>
<li>We copy the objects for the missing commits (<tt class="docutils literal"><span class="pre">4a763d58140b5bf75444c6299d9ffe9a811674a8</span></tt>), missing
trees (<tt class="docutils literal"><span class="pre">7f0de8dd99ee5c9987309668b5835796dc9c98c5</span></tt>) and missing blobs (<tt class="docutils literal"><span class="pre">bfb83ae9365ab2a8343ef5f3cb77f834bdffff93</span></tt>) to the
remote objects directory;</li>
<li>We set remote <tt class="docutils literal"><span class="pre">refs/heads/master</span></tt> to contain the hash <tt class="docutils literal"><span class="pre">4c0d480cc1588b4f3e78f7798ee1103655b8276e</span></tt>;</li>
<li>Set the local <tt class="docutils literal"><span class="pre">refs/remotes/usb_backup/master</span></tt> to contain <tt class="docutils literal"><span class="pre">4c0d480cc1588b4f3e78f7798ee1103655b8276e</span></tt>.</li>
</ol>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="sub-trees" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>You have probably worked out by now that git directory
listings can have files (called &#8220;blobs&#8221;) and subdirectories (&#8220;trees&#8221;).
When doing the copy, we actually have to recurse into any sub-directories
to get needed file (&#8220;blob&#8221;) and subdirectory (&#8220;tree&#8221;) objects.  But, you
get the idea.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">An algorithm for git push</a><ul>
<li><a class="reference internal" href="#paths-through-commits">Paths through commits</a></li>
<li><a class="reference internal" href="#an-algorithm">An algorithm</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="git_object_types.html"
                        title="previous chapter">Types of git objects</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="foundation.html"
                        title="next chapter">Git foundations</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/git_push_algorithm.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="foundation.html" title="Git foundations"
             >next</a> |</li>
        <li class="right" >
          <a href="git_object_types.html" title="Types of git objects"
             >previous</a> |</li>
        <li><a href="index.html">pydagogue 0.2 documentation</a> &raquo;</li>
          <li><a href="git.html" >Notes and tutorials on git</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009, 2010 - Matthew Brett.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>